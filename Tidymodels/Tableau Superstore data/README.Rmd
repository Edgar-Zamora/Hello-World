---
output: 
  md_document:
    variant: markdown_github
---

# Predicting A Products Shipping Mode :package: w/ {tidymodels}

Having seen recent articles and tweets regarding the {tidymodels} package, I decided to give it a try myself. Today I decide to use the superstore dataset that is commonly used when working in Tableau. The superstore data records purchases from fictional customers regarding various products.

As is customary, we start by loading the necessary packages and data.

```{r setup,  message=FALSE, warning=FALSE}
library(tidyverse)
library(tidymodels)
library(janitor)
library(readxl)
library(lubridate)
library(ggthemes)
library(viridis)

orders <- read_excel("data/Global Superstore.xls", sheet = "Orders") %>% 
  clean_names()

#data source: https://community.tableau.com/s/question/0D54T00000C5vSDSAZ/global-superstore-data-file

```

For this post, we use the Superstore dataset from Tableau. The dataset was found on the Tableau community forum and can found [here](https://community.tableau.com/s/question/0D54T00000C5vSDSAZ/global-superstore-data-file). 

# Superstore Data

The superstore dataset consist of transactions (fictional) for customers order, including single and bulk orders. In addition to each individual item, there are other transactional details like order and ship date, shipping mode, profit margin and many other items. Below you can see the complete list that is available


```{r superstore_names, echo=FALSE}
orders %>% 
  colnames()

```

The *main objective* of this post is to **predict a products shipping mode** based on a set of predictors.

Though all factors may be relevant in helping to predict the shipping mode of a customer, I decide to limit it to a few that I believe matter. Note that this decision is not based on any scientific analysis or reach but but instead is my perspective. The variables I decide to go with are *order date*, *shipping data*, *segment*, *shipping cost*, *order priority*, and *profit*. 

```{r superstore_data}
head(orders) %>% 
  select(customer_id, order_date, ship_mode, segment,
         shipping_cost, order_priority, profit)
```

# Data Preperation

Prior to delving into some exploratory analysis, there are some preproceesing steps that we need to take care as to avoid errors when building our models. 

The *first* part of our preproceesing is to create some new variables. Using some `group_by()` on customer id and order date, we are able to count how many items were sent within a particular order. This may matter because a product that is being shipping with many other products may receive a faster shipping mode. The other variable we create is one that tells us in what month a product was shipped in. Using the `month()` function from the {lubridate} package we are able to extract the month. 

The *second* part in our preprocessing is to convert some of the character variables into numerical values. We apply this to the segment, shipping mode, and order priority variable. Later on we will be using the {receipes} package to further process these variables into a form that our models will comport with.

```{r tidy_data}
processed_orders <- orders %>% 
  select(customer_id, order_date, ship_mode, segment,
         shipping_cost, order_priority, profit) %>% 
  group_by(customer_id, order_date) %>% 
  mutate(num_in_order = n()) %>% 
  ungroup() %>% 
  mutate(order_month = month(order_date),
         segment = case_when(segment == "Consumer" ~ 1,
                             segment == "Corporate" ~ 2,
                             TRUE ~ 3), #Home Office
         ship_mode = case_when(ship_mode == "Same Day" ~ 1,
                               ship_mode == "First Class" ~ 2,
                               ship_mode == "Second Class" ~ 3,
                               TRUE ~ 4), # Standard Class
         order_priority = case_when(order_priority == "Critical" ~ 1,
                                    order_priority == "High" ~ 2,
                                    order_priority == "Medium" ~ 3,
                                    TRUE ~ 4)) %>%  #Low
  mutate_at(vars(ship_mode, segment, order_priority, order_month), ~as.factor(.)) %>% 
  select(-c(customer_id, order_date))
  
```

# Exploratory Analysis

Now that we have processed our data, we can begin exploring some of our predectors to see what kind of relationship they have with a products shipping mode.

## Number Of Items In A Order

Below we consider the relationship between the number of items in a order and the preferred method.

```{r explore_num_in_order}

processed_orders %>% 
  count(num_in_order, ship_mode) %>% 
  ggplot(aes(num_in_order, log(n), fill = ship_mode)) +
  geom_col() +
  scale_fill_tableau(name = "Shipping Method",
                     labels = c("Same Day", "First Class", 
                                "Second Class", "Standard Class")) +
  scale_y_continuous(limits = c(0, 40)) +
  scale_x_continuous(breaks = seq(1,14, 1)) +
  labs(
    x = "Number of items in a order",
    y = "Count order (logged)",
    title = "Shipping Method For The Number Of Items In A Order"
  ) +
  theme(
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text = element_text(colour = "black")
  )
  
```

With there being a large positive skew, logging the count of orders also for a potential relationship to be observed. Not associated with our relationship of interest, but we see that there are many orders that content ten or less items per order. As for the number of items in an order pertains to shipping method, we see that "same day" shipping is less preferred as more items added to an order. The trend can be somewhat seen with "second class" and "standard class" shipping. As for the "first class" shipping, we see a ebb and flow in terms of their overall composition of total orders. 

## Shipping Month

```{r explore_shipping_months}

processed_orders %>% 
  count(ship_mode, order_month) %>% 
  group_by(ship_mode) %>% 
  mutate(ship_mode_percent = n/sum(n)) %>% 
  ungroup() %>% 
  ggplot(aes(ship_mode, order_month, fill = ship_mode_percent)) +
  geom_tile() +
  geom_text(aes(label = round(ship_mode_percent * 100, 1)))
  

```



# Creating A Recipe

# Building models

# Reporting Results

# Conclusions
